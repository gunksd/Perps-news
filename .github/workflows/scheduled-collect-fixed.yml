name: Scheduled News Collection

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š10ç‚¹ï¼ˆUTC 2:00 = åŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
    # æ¯å¤©æ™šä¸Š10ç‚¹ï¼ˆUTC 14:00 = åŒ—äº¬æ—¶é—´ 22:00ï¼‰
    - cron: '0 14 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # æˆäºˆæ¨é€æƒé™

jobs:
  collect-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Run news collection
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_API_ENDPOINT: ${{ secrets.AI_API_ENDPOINT }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
        run: |
          echo "å¼€å§‹é‡‡é›†æ–°é—»..."
          npm run collect
          echo "æ–°é—»é‡‡é›†å®Œæˆï¼"

      - name: Check for changes
        id: verify_diff
        run: |
          git diff --quiet data/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # ä¿®å¤ï¼šæ­£ç¡®æ·»åŠ æ‰€æœ‰dataç›®å½•ä¸‹çš„æ–‡ä»¶
          git add data/
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S') é‡‡é›†æ–°é—»æ•°æ®"
          git push

      - name: No changes detected
        if: steps.verify_diff.outputs.changed != 'true'
        run: echo "ğŸ“‹ æ²¡æœ‰æ–°çš„æ–°é—»æ•°æ®éœ€è¦æ›´æ–°"

      # ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤Vercel ISRç¼“å­˜
      - name: Clear Vercel ISR Cache
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ] && [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "ğŸ§¹ æ¸…é™¤Vercel ISRç¼“å­˜..."
            curl -X POST "https://api.vercel.com/v1/deployments/${{ secrets.VERCEL_PROJECT_ID }}/invalidate" \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"paths": ["/zh", "/en"]}'
            echo "âœ… ISRç¼“å­˜å·²æ¸…é™¤"
          else
            echo "âš ï¸ æœªé…ç½®Vercelè®¤è¯ä¿¡æ¯ï¼Œè·³è¿‡ç¼“å­˜æ¸…é™¤"
          fi

      # è§¦å‘Vercelé‡æ–°éƒ¨ç½²ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
      - name: Trigger Vercel deployment
        if: steps.verify_diff.outputs.changed == 'true'
        run: |
          if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
            echo "ğŸš€ è§¦å‘ Vercel é‡æ–°éƒ¨ç½²..."
            curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
            echo "âœ… Vercel éƒ¨ç½²å·²è§¦å‘"
          else
            echo "âš ï¸ æœªé…ç½® VERCEL_DEPLOY_HOOKï¼Œè·³è¿‡éƒ¨ç½²è§¦å‘"
          fi
